resource "google_compute_health_check" "malware-scanner" {
  name = "malware-scanner"
  check_interval_sec = 1
  timeout_sec        = 1

  tcp_health_check {
    port = "8080"
  }
}

resource "google_compute_region_backend_service" "malware-scanner" {
  name                  = "malware-scanner"
  health_checks         = [
    google_compute_health_check.malware-scanner.self_link]
  protocol              = "TCP"
  timeout_sec           = 10
  session_affinity      = "NONE"
  region                = var.region

  backend {
    group = google_compute_instance_group.malware-scanner.self_link
  }
}

resource "google_compute_forwarding_rule" "malware-scanner" {
  name                  = "malware-scanner"
  load_balancing_scheme = "INTERNAL"
  ports                 = ["8080"]
  region                = var.region
  network               = google_compute_network.malware-scanner.self_link
  subnetwork            = google_compute_subnetwork.malware-scanner.self_link
  backend_service       = google_compute_region_backend_service.malware-scanner.self_link
  ip_address            = "10.0.0.10"
}

resource "google_compute_health_check" "squid" {
  name = "squid"
  check_interval_sec = 1
  timeout_sec        = 1

  tcp_health_check {
    port = "3128"
  }
}

resource "google_compute_region_backend_service" "squid" {
  name                  = "squid"
  health_checks         = [
    google_compute_health_check.squid.self_link]
  protocol              = "TCP"
  timeout_sec           = 10
  session_affinity      = "NONE"
  region                = var.region

  backend {
    group = google_compute_instance_group.squid.self_link
  }
}

resource "google_compute_forwarding_rule" "squid" {
  name                  = "squid"
  load_balancing_scheme = "INTERNAL"
  ports                 = ["3128"]
  region                = var.region
  network               = google_compute_network.malware-scanner.self_link
  subnetwork            = google_compute_subnetwork.squid.self_link
  backend_service       = google_compute_region_backend_service.squid.self_link
  ip_address            = "10.0.1.10"
}
resource "google_compute_network" "malware-scanner" {
  name = "malware-scanner"
  auto_create_subnetworks = false
}

resource "google_compute_subnetwork" "malware-scanner" {
  name = "malware-scanner"
  ip_cidr_range = "10.0.0.0/24"
  network = google_compute_network.malware-scanner.name
  description = "For Malware Scan instance."
  region = var.region
  private_ip_google_access = true
}

resource "google_compute_subnetwork" "squid" {
  name = "squid"
  ip_cidr_range = "10.0.1.0/24"
  network = google_compute_network.malware-scanner.name
  description = "For Squid instance."
  region = var.region
  private_ip_google_access = true
}

resource "google_vpc_access_connector" "malware-scanner-connector" {
  name = "malware-scanner-connector"
  ip_cidr_range = "10.0.10.0/28"
  network = google_compute_network.malware-scanner.name
  region = var.region
}


resource "google_compute_firewall" "allow-internal-tcp" {
  name = "allow-internal"
  network = google_compute_network.malware-scanner.name

  source_ranges = ["10.0.0.0/16"]
  allow {
    protocol = "tcp"
    ports = [
      "0-65535"]
  }
}

resource "google_compute_firewall" "allow-ssh" {
  name = "allow-ssh"
  network = google_compute_network.malware-scanner.name

  source_ranges = ["0.0.0.0/0"]
  allow {
    protocol = "tcp"
    ports = [
      "22"]
  }
}

resource "google_compute_firewall" "allow-health-check" {
  name = "allow-health-check"
  network = google_compute_network.malware-scanner.name

  source_ranges = ["35.191.0.0/16", "130.211.0.0/22"]
  allow {
    protocol = "tcp"
    ports = [
      "0-65535"]
  }
}
